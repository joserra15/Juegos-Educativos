<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>El Mundo de los Unicornios</title>
<link rel="icon" type="image/png" href="avatar.png">

<link rel="apple-touch-icon" href="avatar.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Mundos m√°gicos">


<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:"Comic Sans MS", system-ui;
  color:#3a0066;

  background-color:#f3e5f5;

  background-image:
    linear-gradient(
      rgba(255,255,255,0.55),
      rgba(255,255,255,0.55)
    ),
    url("fondo-magico.jpg");

  background-size:cover;
  background-position:center;
	background-repeat:no-repeat;
	min-height:100vh;
}


header{
 display:flex;
 align-items:center;
 gap:12px;
 padding:10px;
 background:#ede7f6;
	position:relative;
  z-index:20;
}


header img{
 width:48px;height:48px;border-radius:50%;
}


.app-header{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 64px;
  padding: 8px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 1000;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}



.header-left{
  display: flex;
  align-items: center;
  gap: 10px;
}

.avatar{
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 2px solid white;
}

.nombre-jugador{
  font-weight: bold;
  font-size: 0.95em;
}

.puntos{
  font-size: 0.9em;
}

.header-right{
  font-size: 1.2em;
  font-weight: bold;
}


h1,h2,h3{text-align:center}
button{
 padding:12px 18px;
 border:none;
 border-radius:18px;
 background:#ff80ab;
 color:white;
 font-size:1.05em;
}
button:disabled{opacity:.4}
input{
 font-size:1.2em;
 padding:8px;
 border-radius:12px;
 border:2px solid #ce93d8;
 width:120px;
}

.tarjeta{
  background:rgba(255,255,255,0.92);
  border-radius:20px;
  padding:16px;
  max-width:900px;
  margin:16px auto;
}

.pantalla{display:none;padding:16px}
.activa{display:block}

.flex{
 display:flex;
 flex-wrap:wrap;
 gap:20px;
 align-items:center;
 justify-content:center;
}

/* ===== Unicornio: marco fijo + revelado limpio ===== */

.unicornio-contenedor{
  width:160px;
  height:160px;
  border-radius:20px;
  background:#f3e5f5;
  border:3px solid #ce93d8;
  display:flex;
  align-items:flex-end;
  justify-content:center;
}

/* M√°scara que crece */
.unicornio-mascara{
  width:100%;
  height:0%;
  overflow:hidden;
  transition:height .5s ease;
}

/* Imagen siempre bien ajustada */
.unicornio-mascara img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
}

/* Popup */
.popup{
 position:fixed;inset:0;
 background:rgba(0,0,0,.45);
 display:none;
 align-items:center;
 justify-content:center;
 z-index:10;
}
.popup .caja{
 background:white;
 padding:20px;
 border-radius:20px;
 text-align:center;
 max-width:320px;
}

/* Panel */
.panel{
 background:white;
 border-radius:20px;
 padding:16px;
 max-width:480px;
 margin:auto;
}
.final img{max-width:90%}


#confeti{
  position:fixed;
  inset:0;
  pointer-events:none;
  overflow:hidden;
  z-index:20;
  display:none;
}

.confeti-pieza{
  position:absolute;
  width:10px;
  height:14px;
  opacity:0.9;
  animation: caer 1.5s linear forwards;
}

@keyframes caer{
  from{
    transform:translateY(-20px) rotate(0deg);
  }
  to{
    transform:translateY(110vh) rotate(360deg);
  }
}


.jugador-actual{
  background:#fff3cd;
  border-radius:10px;
  padding:4px 8px;
  font-weight:bold;
  color:#6a1b9a;
}

#tablaTiempos th,
#tablaTiempos td{
  border:1px solid #ce93d8;
  padding:6px;
}

#tablaTiempos tr:nth-child(even){
  background:#fce4ec;
}


.pantalla.activa{
  animation: entradaPantalla 0.35s ease;
}

@keyframes entradaPantalla{
  from{
    opacity:0;
    transform:translateY(12px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* ===== SOMBRAS SUAVES TIPO APP ===== */

.tarjeta{
  box-shadow:
    0 8px 20px rgba(0,0,0,0.08),
    0 2px 6px rgba(0,0,0,0.06);
}


/* ===== ANIMACI√ìN DE BOTONES ===== */

button{
  transition:
    transform 0.12s ease,
    box-shadow 0.12s ease,
    filter 0.12s ease;
}

button:active{
  transform:scale(0.96);
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
  filter:brightness(0.95);
}


/* ===== FEEDBACK VISUAL DE PUNTOS ===== */

#puntos{
  display:inline-block;
  transition:transform 0.2s ease;
}

#puntos.subiendo{
  animation: puntosSuben 0.6s ease;
  color:#ff4081;
  text-shadow:0 0 8px rgba(255,64,129,0.6);
}

@keyframes puntosSuben{
  0%{
    transform:scale(1);
  }
  30%{
    transform:scale(1.4);
  }
  60%{
    transform:scale(1.1);
  }
  100%{
    transform:scale(1);
  }
}


.bloque-clase{
  margin-bottom:20px;
}

.dato-grande{
  font-size:2em;
  font-weight:bold;
  color:#6a1b9a;
}

.mensaje-clase{
  font-size:0.95em;
  opacity:0.85;
}

.barra-objetivo{
  background:#e0e0e0;
  border-radius:12px;
  overflow:hidden;
  height:18px;
  margin:10px 0;
}

.barra-objetivo > div{
  height:100%;
  background:linear-gradient(90deg,#ba68c8,#f06292);
  width:0%;
  transition:width .4s ease;
}

.tabla-clase{
  width:100%;
  border-collapse:collapse;
}

.tabla-clase th,
.tabla-clase td{
  padding:6px;
  text-align:left;
}

.tarjeta-clase{
  background:rgba(255,255,255,0.85);
  backdrop-filter:blur(6px);
  -webkit-backdrop-filter:blur(6px);

  border-radius:24px;
  padding:20px;

  box-shadow:
    0 10px 25px rgba(0,0,0,0.08),
    inset 0 0 0 1px rgba(255,255,255,0.3);
}

.tarjeta-clase .dato-grande{
  color:#7b1fa2;
  font-weight:700;
}

.tarjeta-clase .bloque-clase{
  margin-bottom:14px;
}

/* ===== PIE DE P√ÅGINA ===== */

.pie{
  margin-top:20px;
  padding:16px 10px;
  text-align:center;
  font-size:0.85em;
  color:#5e3a7a;
  opacity:0.85;
}

.pie a{
  color:#6a1b9a;
  text-decoration:none;
  font-weight:600;
}

.pie a:hover{
  text-decoration:underline;
}

.boton-colectivo{
  background: linear-gradient(135deg, #ffd54f, #ffb300);
  color: #5d3b00;
  border: 3px dashed #ff9800;
  opacity: 1;
}

.boton-colectivo:hover{
  transform: scale(1.05);
  box-shadow: 0 0 12px rgba(255,193,7,0.8);
}

.bottom-nav{
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 64px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 1000;
  box-shadow: 0 -2px 6px rgba(0,0,0,.15);
}

.bottom-nav button{
  background: none;
  border: none;
  font-size: 1.6em;
  cursor: pointer;
  transition: transform .15s;
}

.bottom-nav button:active{
  transform: scale(1.2);
}

.pantalla{
  padding: 16px 16px 88px;
}


.app-header,
.bottom-nav{
  background:
    linear-gradient(180deg, #f4f4f4, #e0e0e0),
    radial-gradient(circle at top left, rgba(255,255,255,0.6), transparent 40%),
    radial-gradient(circle at bottom right, rgba(200,200,255,0.25), transparent 50%);
}


.app-header{
  border-bottom: 1px solid #ddd;
}

.bottom-nav{
  border-top: 1px solid #ddd;
}

body{
  padding-top: 64px;
}

footer{
  margin-top: 40px;
  padding: 16px;
  text-align: center;
  font-size: 0.85em;
  color: #666;
}

.app-header::after{
  content:"";
  position:absolute;
  bottom:0;
  left:20%;
  right:20%;
  height:2px;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(180,150,255,0.8),
    transparent
  );
}

.bottom-nav::before{
  content:"";
  position:absolute;
  top:0;
  left:20%;
  right:20%;
  height:2px;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(180,150,255,0.8),
    transparent
  );
}

@keyframes brilloMagico{
  0%,100%{opacity:0.2;}
  50%{opacity:0.5;}
}

.app-header::before{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(
    120deg,
    transparent 40%,
    rgba(255,255,255,0.3),
    transparent 60%
  );
  animation: brilloMagico 6s infinite;
  pointer-events:none;
}

.titulo-mapa{
  margin-top: 8px;
  margin-bottom: 20px;
}


.mural-mensajes{
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.mensaje-mural{
  background: rgba(255,255,255,0.9);
  border-radius: 14px;
  padding: 10px 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  font-size: 0.95em;
}

.mensaje-sistema{
  border-left: 4px solid #9575cd;
  background: #f3e5f5;
}

.mensaje-jugador{
  border-left: 4px solid #81c784;
}

.texto-ayuda{
  font-size: 0.9em;
  color: #555;
  margin-bottom: 12px;
}

.mural-botones{
  display: flex;
  gap: 10px;
  margin-bottom: 14px;
  justify-content: center;
  flex-wrap: wrap;
}

.mural-botones button{
  font-size: 1.4em;
  padding: 10px 14px;
  border-radius: 16px;
  border: none;
  background: #ede7f6;
  box-shadow: 0 2px 4px rgba(0,0,0,.2);
}

.mural-botones button:active{
  transform: scale(0.95);
}

.mensaje-con-like{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}

.like-btn{
  background: transparent;
  border: none;
  font-size: 0.9em;
  cursor: pointer;
  color: #555;
}

.like-btn.like-activo{
  color: #4caf50;
  font-weight: bold;
}

.like-btn:disabled{
  cursor: default;
  opacity: 0.6;
}

.fecha-mural{
  font-size: 0.7em;
  color: #777;
  margin-bottom: 2px;
}

</style>
</head>

<body>

<header class="app-header">
  <div class="header-left">
    <img src="avatar.png" class="avatar">
    <div>
      <div id="nombreJugadorHeader" class="nombre-jugador">Luc√≠a</div>
      <div class="puntos">‚≠ê <span id="puntos">0</span></div>
    </div>
  </div>

  <div class="header-right">
    ü¶Ñ <span id="progresoMundos">0 / 6</span>
<span id="avatarProgreso">üßç‚Äç‚ôÄÔ∏è</span>
  </div>
</header>


<div id="mapa" class="pantalla activa">
  <h1 class="titulo-mapa">ü¶Ñ El Mundo de los Unicornios</h1>

  <div id="botonesFases" class="flex"></div>
</div>

<!--
 <button onclick="mostrarMochila()">üéí Mochila</button>
<button onclick="mostrarRanking()">üèÜ Ranking</button>
 <button onclick="mostrarPanel()">üìä Padres</button>
-->
</div>


<!-- JUEGO -->
<div id="juego" class="pantalla">
 <h2 id="tituloFase"></h2>
 <h3 id="contador"></h3>
 <div class="flex">
  <div>
   <p id="problema"></p>
<p id="indicadorDificultad" style="font-weight:bold"></p>
   <input type="number" id="respuesta"><br><br>
   <button onclick="responder()">Responder</button>
   <p id="pista"></p>
   <p id="tiempo"></p>
<p id="contadorFallos" style="font-weight:bold; color:#c62828"></p>
  </div>


<div class="unicornio-contenedor">
  <div id="mascaraUnicornio" class="unicornio-mascara">
    <img id="imgUnicornio">
  </div>
</div>

 <button onclick="mostrarMapa()">Volver</button>
 </div>
</div>

<!-- MOCHILA -->
<div id="mochila" class="pantalla">
 <h2>üéí Mochila de logros</h2>
 <div class="panel">

<p>
  üîê <strong>Tu PIN secreto:</strong>
  <span id="pinJugadorUI"></span>
</p>

  <ul id="listaLogros"></ul>

<h3>‚è±Ô∏è Mejores tiempos por mundo</h3>

<table id="tablaTiempos"
       style="width:100%; border-collapse:collapse; text-align:center">
  <thead>
    <tr style="background:#ede7f6">
      <th>Mundo</th>
      <th>Unicornio</th>
      <th>Mejor tiempo</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

 </div><br>
 <button onclick="mostrarMapa()">Volver</button>
</div>

<!-- PANEL PADRES -->
<div id="panel" class="pantalla">
 <h2>üìä Estad√≠sticas</h2>
 <div class="panel">
  <p>Fases completadas: <span id="panelFases"></span></p>
  <p>Tablas dominadas: <span id="panelTablas"></span></p>
  <p>Intentos totales: <span id="panelIntentos"></span></p>
  <h4>‚ùå Operaciones con fallos</h4>
  <ul id="listaFallos"></ul>

<button onclick="mostrar('ayuda')">‚ùì Ayuda</button>

<br>
<br>

<button onclick="iniciarRepasoErrores()">
  üîÅ Repasar operaciones dif√≠ciles
</button>

  <br>
<br>
  <button onclick="resetearTodo()" style="background:#e53935">
   üîÑ Reiniciar todo
  </button>
 </div><br>
 <button onclick="mostrarMapa()">Volver</button>
</div>

<!-- FINAL -->
<div id="final" class="pantalla final">
 <h2>üåà ¬°Has liberado a todos los unicornios <span id="nombreJugadorHeader"></span>, ahora son libres!</h2>
 <img src="unicornios.png">

 <button onclick="mostrarMapa()">Volver</button>

</div>

<!-- POPUP -->
<div id="popup" class="popup">
  <div class="caja">
    <h3 id="popupTexto"></h3>

    <!-- Imagen del unicornio liberado -->
    <img id="popupUnicornio"
         src=""
         style="display:none; width:140px; margin:10px auto;">

    <button onclick="cerrarPopup()">Continuar</button>
  </div>
</div>


<div id="pantallaNombre" class="pantalla">
  <h2>üëß ¬øC√≥mo te llamas?</h2>
  <p>Escribe tu nombre o un apodo</p>

  <input
    id="inputNombre"
    type="text"
    placeholder="Ej: Luc√≠a"
    maxlength="12"
    style="font-size:1.2em; padding:8px; border-radius:10px; text-align:center"
  >

  <br><br>

<p id="errorNombre"
   style="color:#d32f2f; display:none; font-weight:bold">
</p>

  <button onclick="guardarNombre()">Empezar aventura ü¶Ñ</button>
</div>

<div id="ranking" class="pantalla">
  <h2>üèÜ Ranking de puntos</h2>

  <ol id="listaRanking"
      style="font-size:1.2em; line-height:1.6"></ol>

  <br>

<h3>‚ö° Los m√°s r√°pidos de cada mundo</h3>

<table id="tablaRapidos"
       style="width:100%; border-collapse:collapse; margin-top:10px">
  <thead>
    <tr>
      <th>Mundo</th>
      <th>ü•á M√°s r√°pido</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<br>

<div class="tarjeta tarjeta-clase">
  <h2>üè´ Panel de la clase</h2>

  <!-- Puntos de la clase -->
  <div class="bloque-clase">
    <h3>‚≠ê Puntos de toda la clase</h3>
    <p id="puntosClase" class="dato-grande">‚Äî</p>
    <p class="mensaje-clase">
      Cada punto cuenta. ¬°Tu esfuerzo ayuda a todo el grupo!
    </p>
  </div>

<!-- Unicornios liberados -->
  <div class="bloque-clase">
    <h3>ü¶Ñ Unicornios liberados</h3>
    <p id="unicorniosClase" class="dato-grande">‚Äî</p>
    <p class="mensaje-clase">
      Cada unicornio liberado devuelve la magia a los Mundos M√°gicos.
    </p>
  </div>

  <!-- Progreso colectivo -->
  <div class="bloque-clase">
    <h3>üåà Nuevo objetivo colectivo: 60.000 puntos</h3>

    <div class="barra-objetivo">
      <div id="barraClase"></div>
    </div>

    <p id="textoObjetivo" class="mensaje-clase">Si conseguis el objetivo comun apareceran nuevos retos en el juego. ¬øPodreis conseguirlo?</p>
  </div>

  <!-- Tiempo medio -->
  <div class="bloque-clase">
    <h3>‚è±Ô∏è Tiempo medio de la clase</h3>

    <table class="tabla-clase">
      <thead>
        <tr>
          <th>Mundo</th>
          <th>Tiempo medio</th>
        </tr>
      </thead>
      <tbody id="tablaTiemposClase"></tbody>
    </table>

    <p class="mensaje-clase">
      Mejora tu tiempo y ayudar√°s a mejorar el tiempo de toda la clase.
    </p>
  </div>
</div>

<br>

  <button onclick="mostrarMapa()">‚¨Ö Volver</button>
</div>


<div id="historia" class="pantalla">
  <div class="tarjeta">
    <h2>üåà Mundos M√°gicos</h2>

    <p>
      ü¶Ñ Hace mucho tiempo, los unicornios viv√≠an libres y felices en sus mundos,
      pero un hechizo los ha atrapado üò¢
    </p>

    <p>
      ‚ú® Solo alguien valiente y con buena cabeza para los n√∫meros puede liberarlos.
      Cada mundo es un reto y cada reto te acerca a salvar a un unicornio.
    </p>

    <p>
      üèÜ Podr√°s comparar tus avances con tus compa√±eros de clase
      y repetir las fases para mejorar tu tiempo y batir r√©cords.
    </p>

    <p>
      üí´ ¬øNos ayudas a devolver la magia a todos los mundos?
    </p>

    <button onclick="cerrarHistoria()">ü¶Ñ ¬°Empezar la aventura!</button>
  </div>
</div>


<div id="ayuda" class="pantalla">
  <div class="tarjeta">
    <h2>üë®‚Äçüë©‚Äçüëß Ayuda para familias</h2>

    <p>
      <strong>Mundos M√°gicos</strong> es un juego educativo para practicar
      las tablas de multiplicar a trav√©s de retos, mundos y una historia de unicornios.
    </p>

    <h3>üéÆ ¬øC√≥mo se juega?</h3>
    <ul>
      <li>Cada mundo contiene varios retos matem√°ticos.</li>
      <li>Al resolverlos correctamente se liberan unicornios.</li>
      <li>Las fases se pueden repetir para mejorar el tiempo y los puntos.</li>
    </ul>

    <h3>üèÜ Ranking y superaci√≥n</h3>
    <p>
      El juego incluye un ranking para comparar avances de forma sana.
      El objetivo principal es mejorar las propias marcas.
    </p>

    <h3>üîê Nombre y PIN secreto</h3>
    <ul>
      <li>Cada jugador elige un apodo.</li>
      <li>El juego genera un <strong>PIN secreto</strong> visible en la üéí Mochila.</li>
      <li>
        Si se juega desde otro dispositivo o navegador,
        ser√° necesario introducir el mismo nombre y PIN.
      </li>
    </ul>

    <h3>üì± Dispositivos</h3>
    <p>
      Se puede jugar desde m√≥vil, tablet u ordenador usando la misma direcci√≥n web.


      El progreso se sincroniza autom√°ticamente cuando hay conexi√≥n.
    </p>

    <h3>üõ°Ô∏è Privacidad</h3>
    <p>
      No se guardan datos personales. Solo se almacena el apodo
      y el avance en el juego. No se usan correos electr√≥nicos ni contrase√±as.
    </p>

    <h3>‚ôªÔ∏è Aprender es repetir</h3>
    <p>
      Repetir las fases forma parte del aprendizaje.
      El objetivo es mejorar poco a poco y disfrutar del proceso.
    </p>

    <button onclick="mostrarPanel()">‚¨Ö Volver</button>
  </div>
</div>




<div id="mural" class="pantalla">
  <h2 class="titulo-mapa">üåà Mural M√°gico de la Clase</h2>

  <div id="muralBotones" class="mural-botones"></div>

<p class="texto-ayuda" id="contadorMensajes">
  üí¨ Mensajes disponibles hoy: <strong>0</strong>
</p>

  <p class="texto-ayuda">
    Aqu√≠ aparecen los mensajes m√°gicos de la clase y los logros importantes.
  </p>

  <div id="muralMensajes" class="mural-mensajes"></div>
</div>





<script>
  
const TIEMPO_SYNC = 60 * 60 * 1000; // 1 d√≠a en ms

let puntosClase = 0;
let datosClaseCargados = false;


const bancoAvanzado = [
  // ===== TABLA DEL 4 =====
  { a: 4, b: 12, pista: "Haz 4 √ó 10 y suma 4 √ó 2" },
  { a: 4, b: 15, pista: "Descomp√≥n 15 en 10 y 5" },
  { a: 4, b: 18, pista: "Haz 4 √ó 20 y resta 4 √ó 2" },
  { a: 4, b: 25, pista: "25 es 100 dividido entre 4" },
  { a: 4, b: 30, pista: "Multiplica 4 √ó 3 y a√±ade un cero" },

  // ===== TABLA DEL 5 =====
  { a: 5, b: 12, pista: "Haz 5 √ó 10 y suma 5 √ó 2" },
  { a: 5, b: 14, pista: "Haz 5 √ó 10 y suma 5 √ó 4" },
  { a: 5, b: 18, pista: "Haz 5 √ó 20 y resta 5 √ó 2" },
  { a: 5, b: 25, pista: "Multiplica 100 y divide entre 4" },
  { a: 5, b: 30, pista: "Multiplica 5 √ó 3 y a√±ade un cero" },

  // ===== TABLA DEL 6 =====
  { a: 6, b: 12, pista: "Haz 6 √ó 10 y suma 6 √ó 2" },
  { a: 6, b: 15, pista: "Descomp√≥n 15 en 10 y 5" },
  { a: 6, b: 18, pista: "Haz 6 √ó 20 y resta 6 √ó 2" },
  { a: 6, b: 25, pista: "25 es 100 dividido entre 4" },
  { a: 6, b: 30, pista: "Multiplica 6 √ó 3 y a√±ade un cero" },

  // ===== TABLA DEL 7 =====
  { a: 7, b: 12, pista: "Haz 7 √ó 10 y suma 7 √ó 2" },
  { a: 7, b: 14, pista: "Haz 7 √ó 7 y duplica" },
  { a: 7, b: 15, pista: "Descomp√≥n 15 en 10 y 5" },
  { a: 7, b: 20, pista: "Multiplica 7 √ó 2 y a√±ade un cero" },
  { a: 7, b: 30, pista: "Multiplica 7 √ó 3 y a√±ade un cero" },

  // ===== TABLA DEL 8 =====
  { a: 8, b: 12, pista: "Haz 8 √ó 10 y suma 8 √ó 2" },
  { a: 8, b: 15, pista: "Descomp√≥n 15 en 10 y 5" },
  { a: 8, b: 18, pista: "Haz 8 √ó 20 y resta 8 √ó 2" },
  { a: 8, b: 25, pista: "Multiplica por 100 y divide entre 4" },
  { a: 8, b: 30, pista: "Multiplica 8 √ó 3 y a√±ade un cero" },

  // ===== TABLA DEL 9 =====
  { a: 9, b: 12, pista: "Haz 9 √ó 10 y suma 9 √ó 2" },
  { a: 9, b: 14, pista: "Haz 9 √ó 10 y suma 9 √ó 4" },
  { a: 9, b: 15, pista: "Haz 9 √ó 10 y suma 9 √ó 5" },
  { a: 9, b: 18, pista: "Haz 9 √ó 20 y resta 9 √ó 2" },
  { a: 9, b: 30, pista: "Multiplica 9 √ó 3 y a√±ade un cero" },

  // ===== RETOS CON CEROS =====
  { a: 6, b: 40, pista: "Multiplica 6 √ó 4 y a√±ade un cero" },
  { a: 8, b: 40, pista: "Multiplica 8 √ó 4 y a√±ade un cero" },
  { a: 5, b: 40, pista: "Multiplica 5 √ó 4 y a√±ade un cero" },
  { a: 4, b: 40, pista: "Multiplica 4 √ó 4 y a√±ade un cero" },
  { a: 7, b: 40, pista: "Multiplica 7 √ó 4 y a√±ade un cero" }
];


function necesitaSincronizar(){
  const ultimaSync = Number(localStorage.getItem("ultimaSyncFirebase")) || 0;
  return Date.now() - ultimaSync > TIEMPO_SYNC;
}


function sincronizarSiEsNecesario(){
  if(!db || !nombreJugador) return;
  if(!necesitaSincronizar()) return;

  const ref = db.collection("players").doc(nombreJugador);

  ref.get()
    .then(doc => {
      if(!doc.exists) return;

      const remoto = doc.data();

      // üîë Firebase manda si tiene m√°s puntos
      if((remoto.puntos || 0) > puntos){
        puntos = remoto.puntos;
        liberadas = remoto.liberadas || liberadas;
        tiemposMejores = remoto.tiemposMejores || tiemposMejores;
        fallosPorOperacion = remoto.fallosPorOperacion || fallosPorOperacion;

        localStorage.setItem("puntos", puntos);
        localStorage.setItem("fasesLiberadas", JSON.stringify(liberadas));
        localStorage.setItem("tiemposMejores", JSON.stringify(tiemposMejores));
        localStorage.setItem("fallosPorOperacion", JSON.stringify(fallosPorOperacion));

        actualizarPuntosUI();
      }

      // üïí Marcar sincronizaci√≥n
      localStorage.setItem("ultimaSyncFirebase", Date.now());
    })
    .catch(err => {
      console.log("JA üòÇ Error sincronizando");
      console.error(err);
    });
}


function cerrarHistoria(){
  localStorage.setItem("historiaVista", "true");
  mostrarMapa();
}





const puntosPorMundo = {
  "üå∏ Prado Rosa": 10,
  "üå≤ Bosque Esmeralda": 12,
  "‚õ∞Ô∏è Monta√±as Violetas": 15,
  "üêâ Valle del Drag√≥n": 18,
  "üè∞ Castillo Arco√≠ris": 25,
  "üîÆ Santuario del C√°lculo": 35,
"üåÄ Torre del Hechizo": 50
  
};

  const firebaseConfig = {
    apiKey: "AIzaSyDGnZBWvHP_Ge_6c6XgjegGFnWlZwQPnQg",
    authDomain: "unicornios-clase.firebaseapp.com",
    projectId: "unicornios-clase",
    storageBucket: "unicornios-clase.firebasestorage.app",
    messagingSenderId: "451851893754",
    appId: "1:451851893754:web:e37ec6fc7b6dc45cd74243",
    measurementId: "G-T72Z57Z2G6"
  };

  // Initialize Firebase

let db = null;

try{
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore(); // üëà SIN const
  console.log("Firebase inicializado ‚úÖ");
}catch(e){
  console.log("JA üòÇ Firebase no disponible");
  console.error(e);
}



let modoRepaso = false;
let operacionesRepaso = [];
let nombreJugador=localStorage.getItem("nombreJugador");


function iniciarRepasoErrores(){

try{
  const entradas = Object.entries(fallosPorOperacion);

  if(entradas.length === 0){
    alert("No hay operaciones para repasar üéâ");
    return;
  }

  modoRepaso = true;
  indice = 0;
  fallosActual = 0;
  operaciones = [];

  // Ordenar de m√°s fallos a menos
  entradas.sort((a,b) => b[1] - a[1]);

  // Limitar a un m√°ximo razonable (ej. 8)
  const seleccion = entradas.slice(0, 8);

  seleccion.forEach(([clave]) => {
    const [a,b] = clave.split("x").map(Number);

    const t = textos[Math.floor(Math.random()*textos.length)]
      .replace("{a}", a)
      .replace("{b}", b);

    operaciones.push({
      a,
      b,
      r: a*b,
      texto: t + " ¬øCu√°ntos hay en total?"
    });
  });

  document.getElementById("tituloFase").textContent =
    "üîÅ Repaso de operaciones dif√≠ciles";

  document.getElementById("contador").textContent =
    `Pregunta 1 de ${operaciones.length}`;

document.getElementById("mascaraUnicornio").style.height = "0%";
 
indice=0;
 fallosActual=0;
document.getElementById("contadorFallos").textContent = "";


document.getElementById("pista").textContent = "";

tiempoInicio=Date.now();
iniciarTimer();


document.getElementById("imgUnicornio").src = "unicornio1.png";

  mostrar("juego");
  mostrarOperacion();

}catch(err){
 alert(err);
}
}


/* === TEXTOS (40+) === */
const textos=[ "Hay {a} cofres con {b} gemas.","{a} dragones vigilan {b} huevos.","{b} unicornios llevan {a} estrellas.","{a} caminos tienen {b} faroles.","{b} cofres esconden {a} llaves.","{a} hadas preparan {b} pociones.","{b} castillos tienen {a} torres.","{a} grupos de {b} flores.","{b} carros con {a} sacos.","{a} jaulas con {b} dragones.","{b} estanter√≠as con {a} libros.","{a} mesas con {b} pergaminos.","{b} ni√±os reciben {a} cromos.","{a} mochilas con {b} cuentos.","{b} cofres con {a} monedas.","{a} filas de {b} √°rboles.","{b} naves llevan {a} tripulantes.","{a} trenes con {b} vagones.","{b} robots tienen {a} piezas.","{a} casas con {b} ventanas.","{b} cajas con {a} juguetes.","{a} torres con {b} banderas.","{b} globos con {a} cuerdas.","{a} cofres con {b} tesoros.","{b} magos usan {a} varitas.","{a} sacos con {b} semillas.","{b} barcos con {a} velas.","{a} dragones comen {b} peces.","{b} cofres con {a} coronas.","{a} caminos con {b} piedras.","{b} carretas con {a} ruedas.","{a} cofres con {b} estrellas.","{b} √°rboles tienen {a} ramas.","{a} grupos de {b} cristales.","{b} cofres con {a} mapas.","{a} mochilas con {b} cuadernos.","{b} torres con {a} escudos.","{a} cofres con {b} anillos.","{b} estantes con {a} frascos.","{a} cajas con {b} pociones." ];

/* === ESTADO, FASES Y L√ìGICA === */
/* (por l√≠mite del mensaje, esta versi√≥n es funcional pero compactada;
   si quieres la versi√≥n comentada pedag√≥gicamente, te la genero aparte) */

/* =====================================================
   ESTADO GLOBAL
===================================================== */
let puntos = +localStorage.getItem("puntos") || 0;
let faseActual = 0;
let indice = 0;
let operaciones = [];
let liberadas = JSON.parse(localStorage.getItem("fasesLiberadas")) || [0];
let intentosTotales = +localStorage.getItem("intentosTotales") || 0;
let tablasDominadas = JSON.parse(localStorage.getItem("tablasDominadas")) || [];
let logros = JSON.parse(localStorage.getItem("logros")) || [];
let tiemposMejores = JSON.parse(localStorage.getItem("tiemposMejores")) || {};
let fallosPorOperacion = JSON.parse(localStorage.getItem("fallosPorOperacion")) || {};

let tiempoInicio = 0;
let temporizador = null;
let fallosActual = 0;

/* =====================================================
   FASES
===================================================== */
const fases = [
 { 
   nombre:"üå∏ Prado Rosa",
   tablas:[2,3],
   total:8,
   unicornio:"unicornio1.png",
   nombreUnicornio:"Rosita"
 },
 { 
   nombre:"üå≤ Bosque Esmeralda",
   tablas:[4,5],
   total:8,
   unicornio:"unicornio2.png",
   nombreUnicornio:"Esmer√≠n"
 },
 { 
   nombre:"üêâ Valle del Drag√≥n",
   tablas:[6,7],
   total:8,
   unicornio:"unicornio3.png",
   nombreUnicornio:"Drako"
 },
 { 
   nombre:"‚õ∞Ô∏è Monta√±as Violetas",
   tablas:[8,9],
   total:8,
   unicornio:"unicornio4.png",
   nombreUnicornio:"Violeta"
 },
 { 
   nombre:"üè∞ Castillo Arco√≠ris",
   tablas:[2,3,4,5,6,7,8,9],
   total:12,
   unicornio:"unicornio5.png",
   nombreUnicornio:"Arco"
 },
{
  nombre: "üîÆ Santuario del C√°lculo",
  total: 15,
  unicornio: "unicornio6.png",
  nombreUnicornio: "Sabio",
  tipo: "avanzada",
  desbloqueoClase: 20000
},
{
  nombre: "üåÄ Torre del Hechizo",
  total: 20,
  unicornio: "unicornio7.png",
  nombreUnicornio: "Arcano",
  tipo: "avanzada",
  desbloqueoClase: 0,
  siempreActiva: true
}

];

const bancoHechizo = {
  facil: [],
  media: [],
  dificil: []
};

function generarBancoHechizo(){
  bancoHechizo.facil = [];
  bancoHechizo.media = [];
  bancoHechizo.dificil = [];

  while(
    bancoHechizo.facil.length +
    bancoHechizo.media.length +
    bancoHechizo.dificil.length < 60
  ){
    const a = Math.floor(Math.random() * 5) + 4; // 4‚Äì8
    const b = Math.floor(Math.random() * 5) + 2; // 2‚Äì6
    const c = Math.floor(Math.random() * 10) + 1; // +1..10
    const d = Math.floor(Math.random() * 10) + 1; // -1..10

    const expr = `${a}√ó${b}+${c}-${d}`;
    const r = a * b + c - d;

    if(r < 0 || r > 150) continue;

    const op = {
      expr,
      r,
      pista: `üí° ${a} √ó ${b} + ${c} ‚àí ${d}`
    };

    if(r <= 30 && bancoHechizo.facil.length < 18){
      bancoHechizo.facil.push(op);
    }else if(r <= 70 && bancoHechizo.media.length < 18){
      bancoHechizo.media.push(op);
    }else if(bancoHechizo.dificil.length < 24){
      bancoHechizo.dificil.push(op);
    }
  }
}

const mundos = fases.map(f => f.nombre);


/* =====================================================
   MENSAJES PERSONALIZADOS
===================================================== */

function conNombre(texto){
  return texto.replace("{nombre}", nombreJugador || "");
}


const mensajesAcierto = [
  "‚ú® ¬°Genial, {nombre}!",
 "ü¶Ñ ¬°Perfecto! Sigue as√≠ {nombre}",
  "üåü ¬°Esta te ha salido genial!",
  "üíñ ¬°Muy bien pensado!",
  "üéâ ¬°Lo has hecho s√∫per bien!",
  "üëè ¬°Se nota que practicas!",
  "üöÄ ¬°Qu√© rapidez!",
  "üåà ¬°Otro acierto m√°s {nombre}!"
];

const mensajesError = [
  "üí≠ Casi‚Ä¶ piensa un poco m√°s",
  "üîç Prueba otra vez, t√∫ puedes",
  "üß† No pasa nada, int√©ntalo de nuevo",
  "üí™ Sigue intent√°ndolo",
  "‚ú® Vamos otra vez, sin prisas",
  "ü¶Ñ Int√©ntalo de nuevo",
  "üå± De los errores se aprende"
];

const mensajesUltima = [
  "üî• ¬°√öltimo reto, a por √©l!",
  "üèÅ ¬°Esta es la √∫ltima!",
  "üåü √öltima pregunta‚Ä¶ ¬°conf√≠a en ti!",
  "ü¶Ñ El √∫ltimo empuj√≥n"
];

function mensajeAleatorio(arr){
  return arr[Math.floor(Math.random() * arr.length)];
}



/* =====================================================
   MAPA
===================================================== */
function construirMapa(){
  const cont = document.getElementById("botonesFases");
  cont.innerHTML = "";

  fases.forEach((f, i) => {


    const b = document.createElement("button");
    b.textContent = f.nombre + (liberadas.includes(i) ? " ‚úÖ" : "");

// ===== FASE SIEMPRE ACTIVA =====
if (f.siempreActiva) {
  b.disabled = false;
  b.onclick = () => iniciarFase(i);
  cont.appendChild(b);
  return;
}


// ===== FASES AVANZADAS (DESBLOQUEO COLECTIVO) =====
if (f.tipo === "avanzada") {

//para pruebas
//puntosClase=70000;

  const faseAnteriorSuperada = liberadas.includes(i - 1);
  const puntosNecesarios = f.desbloqueoClase || Infinity;
  const puntosSuficientes = puntosClase >= puntosNecesarios;


  if (faseAnteriorSuperada && puntosSuficientes) {
    // üîì Desbloqueada de verdad
    b.disabled = false;
    b.onclick = () => iniciarFase(i);
  } else {
    // üîí Bloqueada (aunque visible)
    b.disabled = true;
    b.classList.add("boton-colectivo");

    b.onclick = () => {
      popup(
        "üåü Reto colectivo üåü\n\n" +
        "Este mundo se desbloquea cuando:\n" +
        "‚úîÔ∏è completes el mundo anterior\n" +
        `‚≠ê la clase llegue a ${puntosNecesarios.toLocaleString()} puntos\n\n` +
        `Progreso actual: ${puntosClase.toLocaleString()} / ${puntosNecesarios.toLocaleString()}`
      );
    };
  }

  cont.appendChild(b);
  return;
}


    // ===== RESTO DE FASES =====
    b.disabled = i > liberadas.length;
    b.onclick = () => iniciarFase(i);

    cont.appendChild(b);
  });

  actualizarProgreso();
}

/* =====================================================
   AUDIO
===================================================== */
let audioCtx;
function sonido(freqs,dur=0.3){
 audioCtx ??= new (window.AudioContext||window.webkitAudioContext)();
 freqs.forEach((f,i)=>{
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=f;
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.001,audioCtx.currentTime+i*0.05);
  g.gain.exponentialRampToValueAtTime(0.3,audioCtx.currentTime+i*0.05+0.05);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+i*0.05+dur);
  o.start(audioCtx.currentTime+i*0.05);
  o.stop(audioCtx.currentTime+i*0.05+dur);
 });
}

/* =====================================================
   INICIAR FASE (orden creciente de dificultad)
===================================================== */
function iniciarFase(i){


if(fases[i].tipo === "avanzada" && puntosClase < 20000){
  popup("üîí Este mundo se desbloquear√° al llegar a 20.000 puntos.\n\n"+
  "Progreso actual "+puntosClase+"/ 20000\n\n"+
  "¬°Cada partida suma para toda la clase!");
  return;
}

//alert("Entrando en fase " + i);
 faseActual=i;
 indice=0;
fallosActual = 0;

// Mostrar contador de fallos en fases con l√≠mite (Castillo y Santuario)
if(!modoRepaso && i >= 4){
  document.getElementById("contadorFallos").textContent =
    "‚ùå Fallos: 0 / 6";
}else{
  document.getElementById("contadorFallos").textContent = "";
}

document.getElementById("pista").textContent = "";

 operaciones=[];
 tiempoInicio=Date.now();
 iniciarTimer();

 operaciones = [];


// ===== CASO ESPECIAL: FASE AVANZADA (FASE 6) =====
if(fases[i].tipo === "avanzada"){

// ===== FASE 7: TORRE DEL HECHIZO =====
if(fases[i].nombre === "üåÄ Torre del Hechizo"){

  generarBancoHechizo();

  const total = fases[i].total;
  const ops = [
    ...bancoHechizo.facil.slice(0, Math.floor(total * 0.3)),
    ...bancoHechizo.media.slice(0, Math.floor(total * 0.3)),
    ...bancoHechizo.dificil.slice(0, total)
  ].slice(0, total);

  operaciones = ops.map(op => ({
    texto: `üßô‚Äç‚ôÇÔ∏è Resuelve el hechizo: ${op.expr}`,
    r: op.r,
    pista: op.pista
  }));

  document.getElementById("imgUnicornio").src = fases[i].unicornio;
  document.getElementById("mascaraUnicornio").style.height = "0%";

  mostrar("juego");
  mostrarOperacion();
  return;
}


// ===== FASE AVANZADA (MUNDO 6) ALEATORIA =====

// Mezclar banco
const mezcladas = bancoAvanzado
  .sort(() => Math.random() - 0.5);

// Seleccionar tantas como indique la fase
operaciones = mezcladas
  .slice(0, fases[i].total)
  .map(op => ({
    ...op,
    r: op.a * op.b,
    texto: `En el santuario hay ${op.a} filas de ${op.b} cristales m√°gicos. ¬øCu√°ntos hay en total?`
  }));

document.getElementById("imgUnicornio").src = fases[i].unicornio;
document.getElementById("mascaraUnicornio").style.height = "0%";

mostrar("juego");
mostrarOperacion();
return;

}


// ===== CASO ESPECIAL: FASE FINAL =====
if(i === fases.length - 1){

  //alert("fase final " + i);
operaciones = [];

  // 1Ô∏è‚É£ Operaciones falladas previamente (solo media y alta)
  let falladas = Object.keys(fallosPorOperacion)
    .map(k => {
      const [a,b] = k.split("x").map(Number);
      return { a, b, r: a*b };
    })
    .filter(op => op.b >= 5); // solo media y alta

  // 2Ô∏è‚É£ Eliminar duplicados y mezclar
  falladas = falladas.filter(
    (op, idx, arr) =>
      idx === arr.findIndex(o => o.a === op.a && o.b === op.b)
  ).sort(() => Math.random() - 0.5);

  // 3Ô∏è‚É£ A√±adir primero las falladas
  falladas.forEach(op => {
    if(operaciones.length < fases[i].total){
      const t = textos[Math.floor(Math.random()*textos.length)]
        .replace("{a}", op.a)
        .replace("{b}", op.b);

      operaciones.push({
        a: op.a,
        b: op.b,
        r: op.r,
        texto: t + " ¬øCu√°ntos hay en total?"
      });
    }
  });

  // 4Ô∏è‚É£ Completar con operaciones nuevas (media y alta)
  let todas = [];
  for(let a = 2; a <= 9; a++){
    for(let b = 5; b <= 9; b++){
      todas.push({ a, b, r: a*b });
    }
  }

  todas = todas
    .filter(op =>
      !operaciones.some(o => o.a === op.a && o.b === op.b)
    )
    .sort(() => Math.random() - 0.5);

  todas.forEach(op => {
    if(operaciones.length < fases[i].total){
      const t = textos[Math.floor(Math.random()*textos.length)]
        .replace("{a}", op.a)
        .replace("{b}", op.b);

      operaciones.push({
        a: op.a,
        b: op.b,
        r: op.r,
        texto: t + " ¬øCu√°ntos hay en total?"
      });
    }
  });

  // Salimos de la funci√≥n para no ejecutar la l√≥gica normal
  document.getElementById("imgUnicornio").src = fases[i].unicornio;
  
document.getElementById("mascaraUnicornio").style.height = "0%";

  mostrar("juego");
  mostrarOperacion();
  return;
}

// 1Ô∏è‚É£ Generar TODAS las combinaciones posibles de la fase
let todas = [];

for (let a of fases[i].tablas) {
  for (let b = 2; b <= 9; b++) {
    todas.push({
      a,
      b,
      r: a * b,
      dificultad: b
    });
  }
}

// 2Ô∏è‚É£ Separar por dificultad
let faciles = todas.filter(o => o.b <= 4);
let medias  = todas.filter(o => o.b >= 5 && o.b <= 6);
let dificiles = todas.filter(o => o.b >= 7);

// 3Ô∏è‚É£ Barajar cada grupo
function mezclar(arr){
  return arr.sort(() => Math.random() - 0.5);
}
faciles = mezclar(faciles);
medias = mezclar(medias);
dificiles = mezclar(dificiles);

// 4Ô∏è‚É£ Construir la fase (progresiva)


const total = fases[i].total;
const nivelAdaptativo = calcularNivelAdaptativo();

// Proporciones base
let numDificiles = Math.max(2, Math.floor(total * 0.25));
let numMedias = Math.floor((total - numDificiles) / 2);
let numFaciles = total - numMedias - numDificiles;

// Ajuste adaptativo
if(nivelAdaptativo === 1){
  numDificiles += 1;
  numFaciles = Math.max(1, numFaciles - 1);
}

if(nivelAdaptativo === 2){
  numDificiles += 2;
  numFaciles = Math.max(1, numFaciles - 2);
}

// Reajuste final por seguridad
const suma = numFaciles + numMedias + numDificiles;
if(suma > total){
  numDificiles -= (suma - total);
}


const seleccion = [
  ...faciles.slice(0, numFaciles),
  ...medias.slice(0, numMedias),
  ...dificiles.slice(0, numDificiles)
];

// 5Ô∏è‚É£ Mezclar SOLO dentro de cada tramo (no el orden global)
operaciones = seleccion.map(op => {
  const t = textos[Math.floor(Math.random() * textos.length)]
    .replace("{a}", op.a)
    .replace("{b}", op.b);

  return {
    a: op.a,
    b: op.b,
    r: op.r,
    texto: t + " ¬øCu√°ntos hay en total?"
  };
});

 document.getElementById("imgUnicornio").src=fases[i].unicornio;
 document.getElementById("imgUnicornio").style.bottom = "-100%";

document.getElementById("indicadorDificultad").textContent = "";
 mostrar("juego");
 mostrarOperacion();
}

/* =====================================================
   MOSTRAR OPERACI√ìN
===================================================== */
function mostrarOperacion(){
 document.getElementById("tituloFase").textContent=fases[faseActual].nombre;
 document.getElementById("contador").textContent=
  `Pregunta ${indice+1} de ${operaciones.length}`;
 document.getElementById("problema").textContent=
  operaciones[indice].texto;

actualizarIndicadorDificultad(operaciones[indice]);
 document.getElementById("respuesta").value="";
 
}

function actualizarIndicadorDificultad(op){
  const el = document.getElementById("indicadorDificultad");

  if(op.b <= 4){
    el.textContent = "üü¢ Nivel f√°cil";
  }else if(op.b <= 6){
    el.textContent = "üü° Nivel medio";
  }else{
    el.textContent = "üî¥ Nivel dif√≠cil";
  }
}

/* =====================================================
   RESPONDER
===================================================== */
function responder(){
 const op=operaciones[indice];
 const val=+respuesta.value;
 intentosTotales++;

 if(val===op.r){
  sonido([880,1320,1760]);
	document.getElementById("pista").textContent = "";

if(!modoRepaso){
	
	// Sistema unificado de puntos por fase
const puntosGanados = puntosDelMundoActual();
puntos += puntosGanados;


  // üéØ GANAR MENSAJES PARA EL MURAL
  const totalGanados = Math.floor(puntos / CONFIG_MURAL.puntosPorMensaje);
  const maxPermitidos = CONFIG_MURAL.maxMensajesDia;

  mensajesDisponibles = Math.min(
    totalGanados - mensajesUsadosHoy,
    maxPermitidos - mensajesUsadosHoy
  );

  mensajesDisponibles = Math.max(0, mensajesDisponibles);

  localStorage.setItem("mensajesDisponibles", mensajesDisponibles);

actualizarContadorMensajes();

}

  indice++;
  fallosActual=0;

  const porcentaje=Math.floor((indice/operaciones.length)*100);


document.getElementById("mascaraUnicornio").style.height =
  porcentaje + "%";

if(porcentaje === 100){
  lanzarConfeti();
}



  if(indice>=operaciones.length){
//alert("LLAMANDO A FINALIZAR FASE");
// üîä Sonido final (permitido porque viene de un click)
  if (faseActual === fases.length - 1) {
    sonidoFinalMagico();
  }

  
   // Mostrar popup de final de fase
popup(
  fases[faseActual].tipo === "avanzada"
    ? "üåü ¬°Has superado el reto avanzado!\nEste reto es solo para mentes expertas."
    : `ü¶Ñ ¬°Has liberado a ${fases[faseActual].nombreUnicornio}!`,
  true
);

// üîë Dejar respirar al navegador para que pinte el popup
requestAnimationFrame(() => {
  requestAnimationFrame(() => {
    finalizarFase();
  });
});



  }else{
   // Mensaje especial si es la √∫ltima pregunta
if(indice === operaciones.length - 1){
  popup(conNombre(mensajeAleatorio(mensajesUltima)));
}else{
  popup(conNombre(mensajeAleatorio(mensajesAcierto)));
}

  }
 }else{
  sonido([1720,1320,800]);

if(!modoRepaso){


const penalizacion = Math.max(3, Math.floor(puntosDelMundoActual() / 2));
puntos -= penalizacion;

  //puntos = Math.max(0, puntos-5);
}

  fallosActual++;

// Mostrar contador de fallos desde la fase 5 en adelante
if(!modoRepaso && faseActual >= 4){
  document.getElementById("contadorFallos").textContent =
    `‚ùå Fallos: ${fallosActual} / 6`;
}

// üîë SI LLEGA A 6 ‚Üí CORTAR AQU√ç
if(!modoRepaso && faseActual >= 4 && fallosActual === 6){

  popup(
    "üö® Has llegado al m√°ximo de fallos permitidos.\nDebes repetir este reto."
  );

  // Reiniciar estado de la fase
  fallosActual = 0;
  modoRepaso = false;

  setTimeout(() => {
    document.getElementById("popup").style.display = "none";
    mostrarMapa();
    document.getElementById("contadorFallos").textContent = "";
  }, 4000);

  return; // ‚õî MUY IMPORTANTE
}



  const clave=`${op.a}x${op.b}`;
  fallosPorOperacion[clave]=(fallosPorOperacion[clave]||0)+1;

  mostrarPista(op);
  popup(conNombre(mensajeAleatorio(mensajesError)));
 }

 guardarEstado();

guardarProgreso();

const puntosEl = document.getElementById("puntos");
//puntosEl.textContent = puntos;
puntosEl.classList.add("subiendo");

setTimeout(() => {
  puntosEl.classList.remove("subiendo");
}, 600);

}



function generarPIN(){
  return Math.floor(1000 + Math.random() * 9000).toString();
}

/* =====================================================
   PISTAS ADAPTATIVAS
===================================================== */
function mostrarPista(op){
  const p = document.getElementById("pista");


if(fases[faseActual].tipo === "avanzada" && op.pista){
  document.getElementById("pista").textContent =
    "üí° " + op.pista;
  return;
}


  // Primer fallo: pista conceptual
  if(fallosActual === 1){
    p.textContent = `Pista: son ${op.a} grupos de ${op.b}.`;
    return;
  }

  // Segundo fallo o m√°s: truco seg√∫n la tabla
  switch(op.a){
    case 2:
      p.textContent = `Pista: doblar ${op.b} ‚Üí ${op.b} + ${op.b}`;
      break;

    case 3:
      p.textContent = `Pista: es el doble de ${op.b} m√°s otro ${op.b}`;
      break;

    case 4:
      p.textContent = `Pista: dobla ${op.b} y vuelve a doblar`;
      break;

    case 5:
      p.textContent = `Pista: piensa en contar de 5 en 5 (termina en 0 o 5)`;
      break;

    case 6:
      p.textContent = `Pista: calcula 3 √ó ${op.b} y luego d√≥blalo`;
      break;

    case 7:
      p.textContent = `Pista: calcula 5 √ó ${op.b} y suma 2 √ó ${op.b}`;
      break;

    case 8:
      p.textContent = `Pista: dobla ${op.b} tres veces seguidas`;
      break;

    case 9:
      p.textContent = `Pista: calcula 10 √ó ${op.b} y resta ${op.b}`;
      break;

    default:
      // Seguridad (no deber√≠a pasar)
      p.textContent = `Pista: ${op.b} + ${op.b} + ... (${op.a} veces)`;
  }
}

function calcularNivelAdaptativo(){
  let nivel = 0;

  // Analizar las √∫ltimas fases completadas (m√°x 2)
  const ultimas = liberadas.slice(-2);

  ultimas.forEach(i => {
    const nombre = fases[i].nombre;
    const tiempo = tiemposMejores[nombre];

    // Si fue r√°pida (menos de 25s) ‚Üí sube dificultad
    if(tiempo && tiempo < 25){
      nivel++;
    }
  });

  // Si no hay muchas operaciones falladas globalmente
  const totalFallos = Object.values(fallosPorOperacion)
    .reduce((a,b)=>a+b,0);

  if(totalFallos < 5){
    nivel++;
  }

  // Limitar el nivel (0,1,2)
  return Math.min(nivel, 2);
}


/* =====================================================
   FINALIZAR FASE
===================================================== */
function finalizarFase(){

try{

if(modoRepaso){
  modoRepaso = false;
  popup("üéâ ¬°Repaso terminado!");
  mostrarMapa();
  return;
}


 clearInterval(temporizador);
 sonido([660,880,1100],0.6);


const puntosGanados = puntosDelMundoActual() * 4;



puntos += puntosGanados;
 //puntos+=50;


// ‚úÖ Marcar fase como superada (todas, incluidas avanzadas)
if(!liberadas.includes(faseActual)){
  liberadas.push(faseActual);
}

agregarMensajeSistema(
  `ü¶Ñ ${nombreJugador} ha liberado a ${fases[faseActual].nombreUnicornio}`
);

 if(fases[faseActual].tablas){
  
if (Array.isArray(fases[faseActual].tablas)) {
  fases[faseActual].tablas.forEach(t => {
    if (!tablasDominadas.includes(t)) {
      tablasDominadas.push(t);
    }
  });
}

}

 const tiempoFinal=Math.floor((Date.now()-tiempoInicio)/1000);
 const nombre=fases[faseActual].nombre;

 if(!tiemposMejores[nombre] || tiempoFinal < tiemposMejores[nombre]){
  tiemposMejores[nombre]=tiempoFinal;
  logros.push(`‚è±Ô∏è Mejor tiempo en ${nombre}: ${tiempoFinal}s`);

agregarMensajeSistema(
  `‚è±Ô∏è ${nombreJugador} ha conseguido un nuevo r√©cord en ${nombre}`
);


 }

 if(fallosActual===0){
  logros.push(`üèÖ Fase perfecta: ${nombre}`);

agregarMensajeSistema(
  `üèÖ ${nombreJugador} ha hecho una fase perfecta`
);

 }

 guardarEstado();

guardarProgreso();

// ===== POPUP DE FINALIZACI√ìN DE FASE =====

// Mostrar siempre el popup de logro



document.getElementById("mascaraUnicornio").style.height ="0%";
actualizarPuntosUI();



// ===== TRANSICI√ìN TRAS POPUP DE FINALIZACI√ìN =====

if(faseActual === fases.length - 1){

  // Dejar visible el popup antes de ir al final
  setTimeout(() => {
    document.getElementById("popup").style.display = "none";
    mostrar("final");
    sonidoFinalMagico();
  }, 3500);

}else{

  // Dejar visible el popup antes de volver al mapa
  setTimeout(() => {
    document.getElementById("popup").style.display = "none";
    mostrarMapa();

    if(calcularNivelAdaptativo() > 0){
      logros.push("üöÄ ¬°El juego ha subido el nivel porque lo est√°s haciendo genial!");
    }

  }, 2500);
}
 
}catch(err){

alert (err)
}


}

/* =====================================================
   TIMER
===================================================== */
function iniciarTimer(){
 clearInterval(temporizador);
 temporizador=setInterval(()=>{
  const s=Math.floor((Date.now()-tiempoInicio)/1000);
  document.getElementById("tiempo").textContent=`‚è±Ô∏è ${s}s`;
 },1000);
}

/* =====================================================
   MOCHILA
===================================================== */
function mostrarMochila(){
 const ul=document.getElementById("listaLogros");
 ul.innerHTML="";
 logros.forEach(l=>{
  const li=document.createElement("li");
  li.textContent=l;
  ul.appendChild(li);
 });

// === Tabla de mejores tiempos ===
const tbody = document
  .querySelector("#tablaTiempos tbody");

tbody.innerHTML = "";

fases.forEach((fase, i) => {
  const tr = document.createElement("tr");

  const tdFase = document.createElement("td");
  tdFase.textContent = fase.nombre;

  const tdUni = document.createElement("td");
  tdUni.textContent = fase.nombreUnicornio;

  const tdTiempo = document.createElement("td");
  const tiempo = tiemposMejores[fase.nombre];
  tdTiempo.textContent = tiempo ? `${tiempo} s` : "‚Äî";

  tr.appendChild(tdFase);
  tr.appendChild(tdUni);
  tr.appendChild(tdTiempo);

  tbody.appendChild(tr);
});

const pin = localStorage.getItem("pinJugador");
document.getElementById("pinJugadorUI").textContent =
  pin ? pin : "‚Äî";


 mostrar("mochila");
}

/* =====================================================
   PANEL FAMILIAR
===================================================== */
function mostrarPanel(){
 document.getElementById("panelFases").textContent=
  `${liberadas.length}/${fases.length}`;
 document.getElementById("panelTablas").textContent=
  tablasDominadas.join(", ");
 document.getElementById("panelIntentos").textContent=
  intentosTotales;

 const ul=document.getElementById("listaFallos");
 ul.innerHTML="";
 Object.entries(fallosPorOperacion)
  .sort((a,b)=>b[1]-a[1])
  .forEach(([op,c])=>{
   const li=document.createElement("li");
   li.textContent=`${op} ‚Üí ${c} fallos`;
   ul.appendChild(li);
  });

 mostrar("panel");
}

/* =====================================================
   RESET TOTAL
===================================================== */


function resetearTodo(){

if(!confirm("¬øSeguro que quieres reiniciar todo el juego?")) return;
  // Borrar datos
  localStorage.removeItem("puntos");
  localStorage.removeItem("fasesLiberadas");
  localStorage.removeItem("tiemposMejores");
  localStorage.removeItem("fallosPorOperacion");

localStorage.removeItem("historiaVista");

  // Reiniciar estado en memoria
  puntos = 0;
  liberadas = [0]; // üîë CLAVE
  tiemposMejores = {};
  fallosPorOperacion = {};

  // Guardar estado inicial correcto
  localStorage.setItem("fasesLiberadas", JSON.stringify(liberadas));
  localStorage.setItem("puntos", puntos);

  // Actualizar interfaz
  document.getElementById("puntos").textContent = puntos;


guardarProgreso();


// Volver al inicio correcto seg√∫n estado
if(!nombreJugador){
  mostrar("pantallaNombre");
}else{
  mostrarMapa();
}
 
}


/* =====================================================
   PROGRESO SUPERIOR
===================================================== */
function actualizarProgreso(){
 document.getElementById("progresoMundos").textContent=
  `${liberadas.length}/${fases.length}`;
 document.getElementById("avatarProgreso").textContent=
  ["üßç‚Äç‚ôÄÔ∏è","üö∂‚Äç‚ôÄÔ∏è","üèÉ‚Äç‚ôÄÔ∏è","ü¶Ñ","üåà"][liberadas.length] || "üåà";
}

/* =====================================================
   UTILIDADES
===================================================== */

function popup(texto, mostrarUnicornio=false){
  document.getElementById("popupTexto").textContent = texto;

  const img = document.getElementById("popupUnicornio");

  if(mostrarUnicornio){
    img.src = fases[faseActual].unicornio;
    img.style.display = "block";
  }else{
    img.style.display = "none";
  }

  document.getElementById("popup").style.display = "flex";
}


function cerrarPopup(){
 document.getElementById("popup").style.display="none";
 if(indice<operaciones.length) mostrarOperacion();
}
function mostrar(id){
 document.querySelectorAll(".pantalla")
  .forEach(p=>p.classList.remove("activa"));
 document.getElementById(id).classList.add("activa");

  window.scrollTo({
    top: 0,
    behavior: "smooth"
  });

sincronizarSiEsNecesario();

}


function actualizarPuntosUI(){

const puntosEl = document.getElementById("puntos");
puntosEl.textContent = puntos;
puntosEl.classList.add("subiendo");

setTimeout(() => {
  puntosEl.classList.remove("subiendo");
}, 600);

}


/* =====================================================
   GUARDAR
===================================================== */
function guardarEstado(){
 localStorage.setItem("puntos",puntos);
 localStorage.setItem("fasesLiberadas",JSON.stringify(liberadas));
 localStorage.setItem("tablasDominadas",JSON.stringify(tablasDominadas));
 localStorage.setItem("logros",JSON.stringify(logros));
 localStorage.setItem("intentosTotales",intentosTotales);
 localStorage.setItem("tiemposMejores",JSON.stringify(tiemposMejores));
 localStorage.setItem("fallosPorOperacion",JSON.stringify(fallosPorOperacion));
 document.getElementById("puntos").textContent=puntos;
 actualizarProgreso();
}

/* =====================================================
   INICIO
===================================================== */
function mostrarMapa(){
try{

cargarPuntosClase(() => {
		//cargarPanelClase();
      construirMapa();
      actualizarPuntosUI();
      mostrar("mapa");
    });
  
}catch(err){
	alert(err);
}

}


function lanzarConfeti(){
  const cont = document.getElementById("confeti");
  cont.style.display = "block";
  cont.innerHTML = "";

  const colores = ["#ff80ab","#ce93d8","#80deea","#ffd54f","#a5d6a7"];

  for(let i=0;i<40;i++){
    const d = document.createElement("div");
    d.className = "confeti-pieza";
    d.style.left = Math.random()*100 + "vw";
    d.style.background =
      colores[Math.floor(Math.random()*colores.length)];
    d.style.animationDelay = (Math.random()*0.5) + "s";
    cont.appendChild(d);
  }

  setTimeout(()=>{
  cont.innerHTML = "";
  cont.style.display = "none";
},1600);

}


function guardarNombre(){
  const input = document.getElementById("inputNombre");
  const error = document.getElementById("errorNombre");

  const nombre = input.value.trim();
const id = nombre.toLowerCase();

  error.style.display = "none";

  if(nombre.length < 2){
    error.textContent = "Escribe un nombre un poco m√°s largo üôÇ";
    error.style.display = "block";
    return;
  }

  // Si Firebase no est√° disponible, dejamos pasar
  if(!db){
    nombreJugador = nombre;

agregarMensajeSistema(
  `‚ú® ${nombreJugador} se ha unido al Reino de los Unicornios`
);
    localStorage.setItem("nombreJugador", nombreJugador);
    actualizarHeaderNombre();
    mostrarMapa();
    return;
  }

  // Comprobar si el nombre ya existe en Firebase
  db.collection("players")
    .doc(nombre)
    .get()
    .then(doc => {
      if(doc.exists){
        
			if(doc.exists){
  const pinGuardado = doc.data().pin;
  const pinIntroducido = prompt(
    "Este jugador ya existe.\nIntroduce tu PIN secreto. Lo tienes en la mochila de la partida anterior:"
  );

  if(pinIntroducido === pinGuardado){
    // PIN correcto ‚Üí cargar datos
    const data = doc.data();

    nombreJugador = nombre;
    cargarProgresoDesdeFirebase();

    localStorage.setItem("nombreJugador", nombreJugador);
    localStorage.setItem("puntos", puntos);
    localStorage.setItem("pinJugador", pinGuardado);

    actualizarHeaderNombre();
    actualizarPuntosUI();
    mostrarMapa();
  }else{
    error.textContent =
      "PIN incorrecto ‚ùå Prueba con otro nombre";
    error.style.display = "block";
  }
}


			

      }else{
        // Nombre libre ‚Üí continuar
        

// Nombre libre ‚Üí crear jugador nuevo
const pin = generarPIN();

nombreJugador = nombre;
puntos = 0;

agregarMensajeSistema(
  `‚ú® ${nombreJugador} se ha unido al Reino de los Unicornios`
);

localStorage.setItem("nombreJugador", nombreJugador);
localStorage.setItem("puntos", puntos);
localStorage.setItem("pinJugador", pin);

db.collection("players")
  .doc(nombreJugador)
  .set({
    nombre: nombreJugador,
    pin: pin,
    puntos: puntos,
    ultimaActualizacion: Date.now()
  });

actualizarHeaderNombre();
actualizarPuntosUI();
mostrar("historia");
//mostrarMapa();


      }
    })
    .catch(err => {
      console.log("JA üòÇ Error comprobando nombre");
      console.error(err);

      // En caso de error, dejamos continuar
      nombreJugador = nombre;
      localStorage.setItem("nombreJugador", nombreJugador);
      actualizarHeaderNombre();
		mostrar("historia");
      //mostrarMapa();
    });
}



function actualizarHeaderNombre(){
  const zona = document.getElementById("nombreJugadorHeader");
  if(zona){
    zona.textContent = nombreJugador;
  }
}


/* ================= FIREBASE: GUARDAR JUGADOR ================= */

function guardarJugadorEnFirebase(){

try{
  if(!db){
    console.log("JA üòÇ db no existe, no se guarda");
    return;
  }

  if(!nombreJugador){
    console.log("JA üòÇ no hay nombreJugador");
    return;
  }

  db.collection("players")
    .doc(nombreJugador)
    .set({
      nombre: nombreJugador,
      puntos: puntos,
      ultimaActualizacion: Date.now()
    })
    .then(() => {
      console.log("Firebase OK ‚úÖ");
    })
    .catch(err => {
      console.log("JA üòÇ Error al guardar en Firebase");
      console.error(err);
    });


}catch(error){
 console.error("Error guardando en Firebase:", error);
}

}


function mostrarRanking(){
  mostrar("ranking");

mostrarRankingRapidos();
cargarPanelClase();

  const lista = document.getElementById("listaRanking");
  lista.innerHTML = "<li>Cargando ranking‚Ä¶</li>";

  if(!db){
    lista.innerHTML =
      "<li>Ranking no disponible sin conexi√≥n</li>";
    return;
  }

  db.collection("players")
    .orderBy("puntos", "desc")
    .limit(20)
    .get()
    .then(snapshot => {
      lista.innerHTML = "";

      if(snapshot.empty){
        lista.innerHTML = "<li>A√∫n no hay datos</li>";
        return;
      }

      let puesto = 1;

      snapshot.forEach(doc => {
        const data = doc.data();

        const li = document.createElement("li");

const esJugadorActual = data.nombre === nombreJugador;

li.textContent = esJugadorActual
  ? `üëâ ${puesto}. ${data.nombre} ‚Äî ${data.puntos} ‚≠ê`
  : `${puesto}. ${data.nombre} ‚Äî ${data.puntos} ‚≠ê`;

if(esJugadorActual){
  li.classList.add("jugador-actual");
}

lista.appendChild(li);
puesto++;
      });
    })
    .catch(err => {
      console.log("JA üòÇ Error leyendo ranking");
      console.error(err);
      lista.innerHTML =
        "<li>Error cargando ranking</li>";
    });
}


generarBancoHechizo();

try{
if(!nombreJugador){
  mostrar("pantallaNombre");
}else{
  actualizarHeaderNombre();
  if(!localStorage.getItem("historiaVista")){
  mostrar("historia");
}else{
  mostrarMapa();
}
}
}catch(error){

mostrarMapa();

}


function guardarProgreso(){
  // Guardar siempre en local
  localStorage.setItem("puntos", puntos);
  localStorage.setItem("fasesLiberadas", JSON.stringify(liberadas));
  localStorage.setItem("tiemposMejores", JSON.stringify(tiemposMejores));
  localStorage.setItem("fallosPorOperacion", JSON.stringify(fallosPorOperacion));

  // Guardar tambi√©n en Firebase si est√° disponible
  if(!db || !nombreJugador) return;

  db.collection("players")
    .doc(nombreJugador)
    .set({
      nombre: nombreJugador,
      pin: localStorage.getItem("pinJugador"),
      puntos,
      liberadas,
      tiemposMejores,
      fallosPorOperacion,
      ultimaActualizacion: Date.now()
    })
    .catch(err => {
      console.log("JA üòÇ Error guardando progreso");
      console.error(err);
    });
}

function cargarProgresoDesdeFirebase(){
  if(!db || !nombreJugador) return;

  db.collection("players")
    .doc(nombreJugador)
    .get()
    .then(doc => {
      if(!doc.exists) return;

      const data = doc.data();

      // Cargar en memoria
      puntos = data.puntos || 0;
      liberadas = data.liberadas || [0];
      tiemposMejores = data.tiemposMejores || {};
      fallosPorOperacion = data.fallosPorOperacion || {};

      // Sincronizar localStorage
      localStorage.setItem("puntos", puntos);
      localStorage.setItem("fasesLiberadas", JSON.stringify(liberadas));
      localStorage.setItem("tiemposMejores", JSON.stringify(tiemposMejores));
      localStorage.setItem("fallosPorOperacion", JSON.stringify(fallosPorOperacion));

      actualizarPuntosUI();
      mostrarMapa();
    })
    .catch(err => {
      console.log("JA üòÇ Error cargando progreso");
      console.error(err);
    });
}


function mostrarRankingRapidos(){
  const tbody = document.querySelector("#tablaRapidos tbody");
  tbody.innerHTML = "";

  if(!db){
    tbody.innerHTML =
      "<tr><td colspan='2'>No disponible sin conexi√≥n</td></tr>";
    return;
  }

  // Inicializamos estructura de mejores tiempos
  const mejores = {};
  mundos.forEach(mundo => {
    mejores[mundo] = {
      nombre: null,
      tiempo: Infinity
    };
  });

  db.collection("players").get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const tiempos = data.tiemposMejores || {};

        mundos.forEach(mundo => {
          if(tiempos[mundo] !== undefined){
            const tiempo = tiempos[mundo];

            if(tiempo < mejores[mundo].tiempo){
              mejores[mundo] = {
                nombre: data.nombre,
                tiempo: tiempo
              };
            }
          }
        });
      });

      // Pintar tabla
      mundos.forEach(mundo => {
        const tr = document.createElement("tr");

        const tdMundo = document.createElement("td");
        tdMundo.textContent = mundo;

        const tdJugador = document.createElement("td");
        const dato = mejores[mundo];

        tdJugador.textContent = dato.nombre
          ? `${dato.nombre} (${dato.tiempo} s)`
          : "‚Äî";

        tr.appendChild(tdMundo);
        tr.appendChild(tdJugador);
        tbody.appendChild(tr);
      });
    })
    .catch(err => {
      console.log("JA üòÇ Error ranking r√°pidos");
      console.error(err);
    });
}

function iniciarAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }

  // üîë CLAVE: reanudar contexto si est√° suspendido
  if(audioCtx.state === "suspended"){
    audioCtx.resume();
  }
}


function reproducirMelodia(notas){
  iniciarAudio();

if(!audioCtx) return;

  let tiempo = audioCtx.currentTime;

  notas.forEach(nota => {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    o.type = "sine";
    o.frequency.value = nota.freq;

    o.connect(g);
    g.connect(audioCtx.destination);

    g.gain.setValueAtTime(0.0001, tiempo);
    g.gain.exponentialRampToValueAtTime(0.3, tiempo + 0.02);
    g.gain.exponentialRampToValueAtTime(
      0.0001,
      tiempo + nota.duracion
    );

    o.start(tiempo);
    o.stop(tiempo + nota.duracion);

    tiempo += nota.duracion;
  });
}



function sonidoFinalMagico(){
  reproducirMelodia([
    // Ascenso m√°gico
    { freq: 523, duracion: 0.25 }, // Do
    { freq: 587, duracion: 0.25 }, // Re
    { freq: 659, duracion: 0.25 }, // Mi
    { freq: 784, duracion: 0.35 }, // Sol

    // Peque√±a pausa emocional
    { freq: 659, duracion: 0.2 },  // Mi
    { freq: 784, duracion: 0.3 },  // Sol
    { freq: 880, duracion: 0.35 }, // La

    // Cl√≠max
    { freq: 1046, duracion: 0.45 }, // Do alto
    { freq: 988, duracion: 0.25 },  // Si
    { freq: 1046, duracion: 0.6 },  // Do alto

    // Resoluci√≥n m√°gica final
    { freq: 784, duracion: 0.4 },   // Sol
    { freq: 659, duracion: 0.3 },   // Mi
    { freq: 523, duracion: 0.9 }    // Do final largo
  ]);
}


function puntosDelMundoActual(){
  const fase = fases[faseActual];
  return puntosPorMundo[fase.nombre] || 10;
}


function cargarPanelClase(){
  if(!db) return;

datosClaseCargados = true;

  let puntosTotales = 0;
  //let unicornios = new Set();
	let totalUnicornios = 0;

  const tiemposPorMundo = {};
  const conteosPorMundo = {};

  db.collection("players").get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();

        // Puntos
        puntosTotales += data.puntos || 0;

        // Unicornios liberados
        totalUnicornios += (data.liberadas || []).length;

        // Tiempos
        const tiempos = data.tiemposMejores || {};
        Object.keys(tiempos).forEach(mundo => {
          if(!tiemposPorMundo[mundo]){
            tiemposPorMundo[mundo] = 0;
            conteosPorMundo[mundo] = 0;
          }
          tiemposPorMundo[mundo] += tiempos[mundo];
          conteosPorMundo[mundo]++;
        });
      });

      // Mostrar puntos
      document.getElementById("puntosClase").textContent =
        puntosTotales.toLocaleString();

      // Mostrar unicornios
      document.getElementById("unicorniosClase").textContent =
        totalUnicornios;

      // Barra de progreso
      const objetivo = 60000;
      const porcentaje = Math.min(100, (puntosTotales / objetivo) * 100);

      document.getElementById("barraClase").style.width = porcentaje + "%";

puntosClase = puntosTotales;

document.getElementById("textoObjetivo").textContent =
        puntosTotales >= objetivo
          ? "üéâ ¬°Objetivo conseguido! La clase ha logrado una gran haza√±a."
          : `Faltan ${objetivo - puntosTotales} puntos para lograr el objetivo y desbloquear nuevos mundos. ¬øPodreis consegurlo?`;

      // Tabla de tiempos medios
      const tbody = document.getElementById("tablaTiemposClase");
      tbody.innerHTML = "";

      Object.keys(tiemposPorMundo).forEach(mundo => {
        const media = Math.round(
          tiemposPorMundo[mundo] / conteosPorMundo[mundo]
        );

        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${mundo}</td><td>${media} s</td>`;
        tbody.appendChild(tr);
      });
    })
    .catch(err => {
      console.error("Error cargando panel de clase", err);
    });

construirMapa();

}


function cargarPuntosClase(callback){

  if(!db){
    if(callback) callback();
    return;
  }

  // Si ya est√° cargado, no volver a pedirlo
  if(datosClaseCargados){
    if(callback) callback();
    return;
  }

  datosClaseCargados = true;

  db.collection("players").get()
    .then(snapshot => {

      let total = 0;

      snapshot.forEach(doc => {
        total += doc.data().puntos || 0;
      });

      puntosClase = total;

      // üîë AVISAR DE QUE YA EST√Å LISTO
      if(callback) callback();

    })
    .catch(err => {
      console.log("Error cargando puntos de la clase");
      console.error(err);

      if(callback) callback(); // para no bloquear la app
    });
}


function mostrarMural(){
try{
  mostrar("mural");
	pintarBotonesMural();
	actualizarContadorMensajes();
	escucharMural();
	
	}catch(err){
	 alert(err);
	}
}



function agregarMensajeSistema(texto){

  // Pintar en pantalla (si estamos en el mural)
  const cont = document.getElementById("muralMensajes");
  if(cont){
    const div = document.createElement("div");
    div.className = "mensaje-mural mensaje-sistema";
    div.textContent = texto;
    cont.appendChild(div);
    cont.scrollTop = cont.scrollHeight;
  }

  // Guardar en Firebase
  if(!db) return;

  db.collection("mural").add({
    tipo: "sistema",
    texto: texto,
	 likes: {},
    fecha: firebase.firestore.FieldValue.serverTimestamp()
  }).catch(err => {
    console.log("Error guardando mensaje del mural");
    console.error(err);
  });
}


function formatearFechaHora(timestamp){
  if(!timestamp) return "";

  const fecha = timestamp.toDate();
  const dia = fecha.toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "2-digit"
  });
  const hora = fecha.toLocaleTimeString("es-ES", {
    hour: "2-digit",
    minute: "2-digit"
  });

  return `${dia} ${hora}`;
}

function escucharMural(){

  if(!db) return;

  db.collection("mural")
    .orderBy("fecha", "desc")
    .limit(30)
    .onSnapshot(snapshot => {

      const cont = document.getElementById("muralMensajes");
      if(!cont) return;

      cont.innerHTML = "";

      snapshot.forEach(doc => {
        const m = doc.data();
        const div = document.createElement("div");
        
			div.className = 
  m.tipo === "sistema"
    ? "mensaje-mural mensaje-sistema"
    : "mensaje-mural mensaje-jugador";


        //div.textContent = m.texto;


const haDadoLike = m.likes && m.likes[nombreJugador];
const totalLikes = m.likes ? Object.keys(m.likes).length : 0;



div.innerHTML = `
  <div class="fecha-mural">
    ${formatearFechaHora(m.fecha)}
  </div>

  <div class="mensaje-con-like">
    <div class="texto-mural">${m.texto}</div>

    <button
      class="like-btn ${haDadoLike ? 'like-activo' : ''}"
      onclick="toggleLike('${doc.id}')"
      ${haDadoLike ? 'disabled' : ''}
    >
      üëç ${totalLikes}
    </button>
  </div>
`;

      

        cont.appendChild(div);
      });

      cont.scrollTop = cont.scrollHeight;
    });
}

//agregarMensajeSistema("‚ú® Bienvenidos al Mural M√°gico de la Clase");


const mensajesPredefinidos = {
  animo: {
    icono: "‚≠ê",
    texto: "¬°Vamos equipo!"
  },
  logrado: {
    icono: "üéâ",
    texto: "¬°Reto superado!"
  },
  esfuerzo: {
    icono: "üí™",
    texto: "Lo voy a intentar otra vez"
  },
  clase: {
    icono: "üåà",
    texto: "¬°La clase va genial!"
  },
  cerca: {
    icono: "üîÆ",
    texto: "¬°Estamos cerca del siguiente mundo!"
  },
  unicornio: {
    icono: "ü¶Ñ",
    texto: "¬°Los unicornios nos necesitan!"
  },
  estrellas: {
    icono: "‚ú®",
    texto: "¬°Buen trabajo!"
  },
  tiempo: {
    icono: "‚è±Ô∏è",
    texto: "¬°Hemos mejorado el tiempo!"
  },
  ayuda: {
    icono: "üëãüèª",
    texto: "¬°Hola a todos!"
  },
  magia: {
    icono: "ü•á",
    texto: "¬°Somos unos campeones!"
  }
};


function toggleLike(idMensaje){
  if(!db || !nombreJugador) return;

  const ref = db.collection("mural").doc(idMensaje);

  ref.get().then(doc => {
    if(!doc.exists) return;

    const data = doc.data();
    const likes = data.likes || {};

    if(likes[nombreJugador]) return; // ya reaccion√≥

    ref.update({
      [`likes.${nombreJugador}`]: true
    });
  }).catch(err => {
    console.log("Error al dar like");
    console.error(err);
  });
}

let ultimoMensajeMural = 0;

function enviarMensajePredefinido(idMensaje){


comprobarResetDiarioMensajes();

if(mensajesDisponibles <= 0){
  popup(
    "üîí No tienes mensajes m√°gicos disponibles.\n\n" +
    "Juega partidas para ganar m√°s ‚ú®"
  );
  return;
}


if (mensajesUsadosHoy === CONFIG_MURAL.maxMensajesDia){

popup(
    "üîí Ya has enviado el maximo de mensajes permitido hoy ‚ú®"
  );
  return;

}

  const texto = mensajesPredefinidos[idMensaje];
  if(!texto) return;

  const ahora = Date.now();
  if(ahora - ultimoMensajeMural < 8000){
    popup("‚è≥ Espera un poco antes de enviar otro mensaje");
    return;
  }
  ultimoMensajeMural = ahora;


mensajesUsadosHoy++;

localStorage.setItem("mensajesDisponibles", mensajesDisponibles);
localStorage.setItem("mensajesUsadosHoy", mensajesUsadosHoy);

actualizarContadorMensajes();

  // Guardar en Firebase
  if(!db || !nombreJugador) return;

  db.collection("mural").add({
    tipo: "jugador",
    texto: `${nombreJugador}: ${texto.texto}`,
    fecha: firebase.firestore.FieldValue.serverTimestamp()
  }).catch(err => {
    console.log("Error enviando mensaje predefinido");
    console.error(err);
  });
}


const reaccionesDisponibles = ["üëè", "‚ù§Ô∏è", "üëç", "‚≠ê"];



function reaccionarMensaje(idMensaje, emoji){
  if(!db) return;

  const ref = db.collection("mural").doc(idMensaje);

  ref.get().then(doc => {
    if(!doc.exists) return;

    const data = doc.data();
    const reacciones = data.reacciones || {};

    const valorActual = reacciones[emoji] || 0;

    return ref.update({
      [`reacciones.${emoji}`]: valorActual + 1
    });
  }).catch(err => {
    console.log("Error al reaccionar al mensaje");
    console.error(err);
  });
}



function pintarBotonesMural(){
  const cont = document.getElementById("muralBotones");
  if(!cont) return;

  cont.innerHTML = "";

  Object.entries(mensajesPredefinidos).forEach(([id, texto]) => {
    // El emoji ser√° el bot√≥n (primer car√°cter del texto)
    const emoji = texto.icono;

    const btn = document.createElement("button");
    btn.textContent = emoji;

	btn.title = texto.texto;

    
    btn.onclick = () => enviarMensajePredefinido(id);

    cont.appendChild(btn);
  });
}

/* ===============================
   CONFIGURACI√ìN MURAL M√ÅGICO
================================ */

const CONFIG_MURAL = {
  maxMensajesDia: 10,          // üîß M√°ximo de mensajes diarios
  puntosPorMensaje: 250       // üîß Puntos necesarios para ganar 1 mensaje
};

let mensajesDisponibles = 0;
let mensajesUsadosHoy = 0;
let ultimoDiaMensajes = localStorage.getItem("ultimoDiaMensajes") || "";

//ultimoDiaMensajes=null;


function comprobarResetDiarioMensajes(){
  const hoy = new Date().toISOString().slice(0,10);

  if(ultimoDiaMensajes !== hoy){
    mensajesDisponibles = 0;
    mensajesUsadosHoy = 0;
    ultimoDiaMensajes = hoy;

    localStorage.setItem("ultimoDiaMensajes", hoy);
    localStorage.setItem("mensajesDisponibles", mensajesDisponibles);
    localStorage.setItem("mensajesUsadosHoy", mensajesUsadosHoy);
  }
}

function actualizarContadorMensajes(){
  const el = document.getElementById("contadorMensajes");
  if(!el) return;

  el.innerHTML =
    `üí¨ Mensajes disponibles hoy: <strong>${mensajesDisponibles}</strong> / ${CONFIG_MURAL.maxMensajesDia}. Enviados ${mensajesUsadosHoy}`;
}

</script>

<div id="confeti"></div>


<div id="avisoLegal" class="pantalla">
  <div class="tarjeta tarjeta-clase">
    <h2>‚öñÔ∏è Aviso legal</h2>

    <p><strong>Titular del sitio web</strong><br>
    Mundos M√°gicos Educativos<br>
    üì© info@mundosmagicoseducativos.es</p>

    <p><strong>Finalidad del sitio web</strong><br>
    Este sitio web tiene una finalidad educativa, ofreciendo actividades
    interactivas para el aprendizaje y refuerzo de las tablas de multiplicar
    en un entorno l√∫dico y motivador.</p>

    <p><strong>Uso del sitio</strong><br>
    El uso de esta aplicaci√≥n implica la aceptaci√≥n del presente aviso legal.
    El contenido est√° dirigido a un uso educativo, tanto en el √°mbito familiar
    como escolar.</p>

    <p><strong>Datos personales y privacidad</strong><br>
    Esta aplicaci√≥n no solicita ni almacena datos personales identificativos.
    √önicamente se guarda un apodo elegido por el jugador y el progreso dentro
    del juego (puntos, tiempos y fases).</p>

<p><strong>Uso de cookies</strong><br>
Esta aplicaci√≥n no utiliza cookies de seguimiento ni cookies publicitarias.
√önicamente se emplea almacenamiento local del navegador para guardar el
progreso del juego.</p>

    <p><strong>Responsabilidad</strong><br>
    Mundos M√°gicos Educativos no se hace responsable del uso indebido de la
    aplicaci√≥n ni de posibles interrupciones del servicio por causas t√©cnicas.</p>

    <p><strong>Propiedad intelectual</strong><br>
    Los contenidos, dise√±o, textos, im√°genes y c√≥digo de esta aplicaci√≥n son
    propiedad de Mundos M√°gicos Educativos o se utilizan con fines educativos.
    Queda prohibida su reproducci√≥n total o parcial con fines comerciales sin
    autorizaci√≥n expresa.</p>

    <button onclick="mostrar('mapa')">‚¨Ö Volver</button>
  </div>
</div>

<footer class="pie">
  <p>
    üì© Contacto:
    <a href="mailto:info@mundosmagicoseducativos.es">
      info@mundosmagicoseducativos.es
    </a>
    ¬∑
<br>
    <a href="#" onclick="mostrar('avisoLegal')">
      Aviso legal
    </a>
  </p>
  <p>
    v 1.4.2
  </p>
<p><br></p>
</footer>


<nav class="bottom-nav">
  <button onclick="mostrarMapa()" title="Mapa">üó∫Ô∏è</button>
  <button onclick="mostrarMochila()" title="Mochila">üéí</button>
	<button onclick="mostrarMural()" 
title="Mural">üåà</button>
  <button onclick="mostrarRanking()" title="Ranking">üèÜ</button>
  <button onclick="mostrarPanel()" title="Familia">üë®‚Äçüë©‚Äçüëß</button>
</nav>




</body>
</html>